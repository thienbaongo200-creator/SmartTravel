{% extends "base.html" %}
{% load static %}

{% block title %}Trang Chủ{% endblock %}

{% block content %}
<section id="banner">
    <h1>Bản đồ du lịch thông minh</h1>
    <p>Khám phá địa điểm nổi bật và lên kế hoạch chuyến đi dễ dàng</p>
    <div style="margin-top:15px;"> 
        <input type="text" id="searchBox" placeholder="Nhập tên địa điểm..." style="padding:6px; width:250px;"> 
        <button onclick="searchPlace()" style="padding:6px 12px;">Tìm kiếm</button> 
        <button onclick="locateUser()" class="btn">Vị trí của tôi</button>
    </div>
    <a href="#map" class="btn" style="display:inline-block; margin-top:30px;">
    Khám phá ngay
</a>
</section>

<div id="map" style="height:500px; width:100%;"></div>
<div id="loading" style="display:none;
     position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(255,255,255,0.8);
     z-index:9999; text-align:center; padding-top:200px; font-size:30px;">
    Đang xác định vị trí...
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([10.762622, 106.660172], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let geoData = null;

    fetch("{% static 'data/data.geojson' %}")
    .then(res => res.json())
    .then(data => {
        geoData = data;
        L.geoJSON(data, {
            onEachFeature: function (feature, layer) {
                let p = feature.properties;
                let popupContent = `
                    <div style="text-align:center;">
                        <h3 style="color:#3498db;">${p.name}</h3>
                        <img src="${p.img}" width="220" style="border-radius:8px; margin:10px 0;">
                        <p><strong>Loại:</strong> ${p.type || "Địa điểm"}</p>
                        <p><strong>Đánh giá:</strong> ⭐ ${p.rating || "Chưa có"}</p>
                        <p><strong>Địa chỉ:</strong> ${p.address || "Đang cập nhật"}</p>
                        <p><strong>Giờ mở cửa:</strong> ${p.open_hours || "Không rõ"}</p>
                        <p>${p.desc}</p>
                    </div>
                `;
                layer.bindPopup(popupContent);
            }
        }).addTo(map);
    });

    function searchPlace() {
        let keyword = document.getElementById("searchBox").value.toLowerCase().trim();
        if (!geoData) {
            alert("Dữ liệu đang tải, vui lòng thử lại sau!");
            return;
        }

        let found = false;
        geoData.features.forEach(f => {
            let p = f.properties;
            if (p.name.toLowerCase().includes(keyword) ||
                (p.type && p.type.toLowerCase().includes(keyword))) {

                let coords = f.geometry.coordinates;
                map.setView([coords[1], coords[0]], 15);
                L.popup()
                  .setLatLng([coords[1], coords[0]])
                  .setContent(`<strong>${p.name}</strong><br>${p.address || ""}`)
                  .openOn(map);
                found = true;
            }
        });

        if (!found) {
            alert("Không tìm thấy kết quả phù hợp!");
        }
    }

    let userMarker = null; 

    function locateUser() {
        if (!navigator.geolocation) {
            alert("Trình duyệt không hỗ trợ định vị!");
            return;
        }

        document.getElementById("loading").style.display = "block";

        navigator.geolocation.watchPosition(
            function (position) {
                let lat = position.coords.latitude;
                let lng = position.coords.longitude;

                if (userMarker) {
                    map.removeLayer(userMarker);
                }

                userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Vị trí của bạn").openPopup();

                map.setView([lat, lng], 15);

                document.getElementById("loading").style.display = "none";
            },
            function (error) {
                alert("Không thể lấy vị trí: " + error.message);
                document.getElementById("loading").style.display = "none";
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
    }
</script>
{% endblock %}